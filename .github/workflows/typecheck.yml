name: Typecheck

on: [pull_request, workflow_dispatch]

jobs:
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: bahmutov/npm-install@v1
        with:
          install-command: npm ci --legacy-peer-deps
      - name: Run tsc
        run: npm run typecheck
  gql:
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.pull_request.head.repo.full_name, 'replayio/')
    name: GraphQL schema types
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: bahmutov/npm-install@v1
        with:
          install-command: npm ci --legacy-peer-deps
      - name: Fetch GraphQL schema
        run: npm run gql:schema
        env:
          HASURA_KEY: ${{ secrets.HASURA_ADMIN_SECRET }}
      - name: Apollo codegen
        run: rm -rf src/graphql/*.ts && npm run gql:gen
      - name: Checks if types match
        run: git diff --quiet HEAD -- src/graphql
